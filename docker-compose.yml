services:
  # Kafka with Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - soc-net

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT_HOST://0.0.0.0:29092,PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT_HOST://localhost:29092,PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT_HOST:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - soc-net

  # MongoDB
  mongo:
    image: mongo:7.0
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: soc_db
    volumes:
      - mongo-data:/data/db
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - soc-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - soc-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # OpenSearch
  opensearch:
    image: opensearchproject/opensearch:2.15.0
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - soc-net
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q green"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ingestion Service (receives SDK telemetry, publishes to Kafka)
  ingestion-service:
    build: ./soc-ingestion
    ports:
      - "8000:8000"
    environment:
      - INGESTION_SERVICE_NAME=soc-ingestion
      - INGESTION_PORT=8000
      - INGESTION_MONGO_URI=mongodb://mongo:27017
      - INGESTION_DB_NAME=soc_db
      - INGESTION_REDIS_URL=redis://redis:6379/0
      - INGESTION_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - INGESTION_KAFKA_TOPIC=raw-activity
      - INGESTION_RATE_LIMIT_PER_MINUTE=300
    networks:
      - soc-net
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_started
    restart: unless-stopped

  # Normalizer Service
  normalizer-service:
    build: ./normalizer-service
    command: ["uv", "run", "python", "main.py"]
    ports:
      - "8001:8001"
    environment:
      - NORMALIZER_SERVICE_NAME=normalizer-service
      - NORMALIZER_LOG_LEVEL=INFO
      - NORMALIZER_PORT=8001
      - NORMALIZER_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - NORMALIZER_KAFKA_GROUP_ID=normalizer-v1
      - NORMALIZER_KAFKA_INPUT_TOPIC=raw-activity
      - NORMALIZER_KAFKA_OUTPUT_TOPIC=normalized-activity
      - NORMALIZER_OPENSEARCH_URL=http://opensearch:9200
      - NORMALIZER_OPENSEARCH_USERNAME=admin
      - NORMALIZER_OPENSEARCH_PASSWORD=admin
      - NORMALIZER_GEOIP_DB_PATH=./data/GeoLite2-City.mmdb
      - NORMALIZER_USER_SERVICE_BASE_URL=http://user-service
      - NORMALIZER_USER_SERVICE_TIMEOUT_S=0.1
      - NORMALIZER_MAX_ENRICH_CONCURRENCY=50
      - NORMALIZER_INTERNAL_AUTH_TOKEN=soc-internal-token-v1
    networks:
      - soc-net
    depends_on:
      kafka:
        condition: service_started
      opensearch:
        condition: service_healthy
      user-service:
        condition: service_started
    restart: unless-stopped

  # Detection & Scoring Engine
  detection-service:
    build: ./detection-scoring-engine
    command: ["uv", "run", "python", "main.py"]
    ports:
      - "8005:8005"
    environment:
      - DETECTION_SERVICE_NAME=detection
      - DETECTION_LOG_LEVEL=INFO
      - DETECTION_PORT=8005
      - DETECTION_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - DETECTION_KAFKA_CONSUMER_GROUP=detections-v1
      - DETECTION_KAFKA_INPUT_TOPIC=normalized-activity
      - DETECTION_KAFKA_OUTPUT_TOPIC=detection-events
      - DETECTION_OPENSEARCH_URL=http://opensearch:9200
      - DETECTION_OPENSEARCH_USERNAME=admin
      - DETECTION_OPENSEARCH_PASSWORD=admin
      - DETECTION_DETECTION_INDEX_PREFIX=detections-
      - DETECTION_NORMALIZED_INDEX_PREFIX=logs-
      - DETECTION_INTERNAL_AUTH_TOKEN=soc-internal-token-v1
      - DETECTION_OS_QUERY_TIMEOUT=5
    networks:
      - soc-net
    depends_on:
      kafka:
        condition: service_started
      opensearch:
        condition: service_healthy
    restart: unless-stopped

  # User Service (mock for role enrichment)
  user-service:
    image: kennethreitz/httpbin:latest
    ports:
      - "8080:80"
    networks:
      - soc-net

  # Case Service
  case-service:
    build: ./case-service
    ports:
      - "8004:8004"
    environment:
      - CASE_SERVICE_NAME=case-service
      - CASE_LOG_LEVEL=INFO
      - CASE_PORT=8004
      - CASE_INTERNAL_AUTH_TOKEN=soc-internal-token-v1
      - MONGO_URI=mongodb://mongo:27017
      - DB_NAME=soc_db
      - INTERNAL_TOKEN=soc-internal-token-v1
      - JWT_SECRET=soc-dashboard-jwt-secret-change-in-production
      - DETECTION_SERVICE_URL=http://detection-service:8005
      - NORMALIZER_SERVICE_URL=http://normalizer-service:8001
    networks:
      - soc-net
    depends_on:
      mongo:
        condition: service_healthy
      kafka:
        condition: service_started
    restart: unless-stopped

  # Agent Trigger Service
  agent-trigger-service:
    build: ./agents-service
    command: ["uv", "run", "python", "trigger.py"]
    ports:
      - "8002:8002"
    environment:
      - TRIGGER_SERVICE_NAME=agent-trigger-service
      - TRIGGER_LOG_LEVEL=INFO
      - TRIGGER_PORT=8002
      - TRIGGER_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - TRIGGER_KAFKA_INPUT_TOPIC=detection-events
      - TRIGGER_KAFKA_GROUP_ID=agent-trigger-v1
      - TRIGGER_KAFKA_AUTO_OFFSET_RESET=earliest
      - TRIGGER_CREWAI_SERVICE_URL=http://crewai-service:8003
      - TRIGGER_CREWAI_KICKOFF_ENDPOINT=/kickoff
      - TRIGGER_INTERNAL_AUTH_TOKEN=soc-internal-token-v1
    networks:
      - soc-net
    depends_on:
      - kafka
      - crewai-service
    restart: unless-stopped

  # CrewAI Service
  crewai-service:
    build: ./agents-service
    command: ["uv", "run", "python", "crewai_service.py"]
    env_file:
      - .env
    ports:
      - "8003:8003"
    environment:
      - CREWAI_SERVICE_NAME=crewai-service
      - CREWAI_LOG_LEVEL=INFO
      - CREWAI_PORT=8003
      - CREWAI_LLM_PROVIDER=openrouter
      - CREWAI_LLM_API_KEY=${OPENROUTER_API_KEY}
      - CREWAI_LLM_API_BASE=https://openrouter.ai/api/v1
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_BASE=https://openrouter.ai/api/v1
      - OPENAI_MODEL_NAME=openrouter/openai/gpt-4
      - CREWAI_LLM_MODEL=openai/gpt-4
      - CREWAI_LLM_TEMPERATURE=0.1
      - CREWAI_LLM_MAX_TOKENS=4096
      - CREWAI_LLM_CACHE_ENABLED=true
      - CREWAI_LLM_CACHE_TTL_SECONDS=3600
      - CREWAI_NORMALIZER_SERVICE_URL=http://normalizer-service:8001
      - CREWAI_NORMALIZER_LOG_QUERY_ENDPOINT=/internal/query-logs
      - CREWAI_CASE_SERVICE_URL=http://case-service:8004
      - CREWAI_CASE_ACTION_ENDPOINT=/internal/case-action
      - CREWAI_AGENT_OUTPUT_ENDPOINT=/internal/agent-output
      - CREWAI_INTERNAL_AUTH_TOKEN=soc-internal-token-v1
      - CREWAI_MAX_FLOW_DURATION_SECONDS=3600
      - CREWAI_AGENT_TIMEOUT_SECONDS=300
    networks:
      - soc-net
    depends_on:
      case-service:
        condition: service_started
      normalizer-service:
        condition: service_started
      kafka:
        condition: service_started
    restart: unless-stopped

  # SOC Dashboard (Streamlit)
  soc-dashboard:
    build: ./soc-case-dashboard
    ports:
      - "8501:8501"
    environment:
      - CASE_SERVICE_URL=http://case-service:8004
      - DETECTION_SERVICE_URL=http://detection-service:8005
    networks:
      - soc-net
    depends_on:
      case-service:
        condition: service_started
      detection-service:
        condition: service_started
    restart: unless-stopped

networks:
  soc-net:
    driver: bridge

volumes:
  kafka-data:
  opensearch-data:
  mongo-data:
